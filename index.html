<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –ö–∞—Å—Å–æ–≤—ã—Ö –ö–Ω–∏–≥ - Google Sheets</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            background-attachment: fixed;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .login-section {
            padding: 50px;
            text-align: center;
            background: #f8f9fa;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .login-form h2 {
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 8px;
            width: 100%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .main-content {
            display: none;
            padding: 30px;
        }

        .user-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .user-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .store-selector {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .store-selector label {
            font-weight: 600;
            color: #495057;
        }

        .store-selector select {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
        }

        .cash-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            position: relative;
            table-layout: fixed;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .cash-table td:nth-child(1) { width: 8%; }  /* –î–∞—Ç–∞ */
        .cash-table td:nth-child(2) { width: 10%; } /* –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –Ω–∞—á–∞–ª–æ */
        .cash-table td:nth-child(3) { width: 8%; }  /* –ü—Ä–∏—Ö–æ–¥ */
        .cash-table td:nth-child(4) { width: 15%; } /* –ò—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∏—Ö–æ–¥–∞ */
        .cash-table td:nth-child(5) { width: 8%; }  /* –†–∞—Å—Ö–æ–¥ */
        .cash-table td:nth-child(6) { width: 15%; } /* –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ */
        .cash-table td:nth-child(7) { width: 8%; }  /* –°–Ω—è—Ç–∏–µ */
        .cash-table td:nth-child(8) { width: 10%; } /* –§–∞–º–∏–ª–∏—è —Å–Ω–∏–º–∞—é—â–µ–≥–æ */
        .cash-table td:nth-child(9) { width: 10%; } /* –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –∫–æ–Ω–µ—Ü */

        .cash-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .cash-table thead th {
            position: sticky !important;
            top: 0 !important;
            z-index: 10 !important;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .cash-table thead {
            position: sticky !important;
            top: 0 !important;
            z-index: 10 !important;
        }

        .cash-table th {
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #34495e;
        }

        .cash-table td {
            padding: 12px 10px;
            border: 1px solid #e9ecef;
            text-align: center;
            vertical-align: middle;
        }

        .cash-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .cash-table tr:hover {
            background: linear-gradient(90deg, #e3f2fd 0%, #f0f8ff 100%);
            transform: scale(1.001);
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .input-cell {
            padding: 5px;
            border: none;
            background: transparent;
            width: 100%;
            text-align: center;
            font-size: 14px;
            resize: vertical;
            min-height: 20px;
            max-height: 100px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .input-cell:focus {
            outline: none;
            background: linear-gradient(135deg, #fff3cd 0%, #fff8dc 100%);
            border-radius: 8px;
            overflow: visible;
            z-index: 100;
            position: relative;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
            border: 2px solid #ffc107;
            transform: scale(1.02);
        }

        .input-cell:disabled {
            background: #f8f9fa;
            color: #6c757d;
        }

        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π */
        .text-input-cell {
            text-align: left;
            padding: 8px;
            font-size: 13px;
            line-height: 1.3;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 30px;
            max-height: 80px;
        }

        .text-input-cell:focus {
            min-height: 60px;
            max-height: 120px;
        }

        /* Tooltip –¥–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
        .cell-tooltip {
            position: relative;
            cursor: help;
        }

        .cell-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: pre-wrap;
            max-width: 300px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .balance-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        .positive {
            color: #28a745;
        }

        .negative {
            color: #dc3545;
        }

        .summary {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .summary h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .summary-item h4 {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .summary-item .value {
            font-size: 1.5em;
            font-weight: 600;
            color: #2c3e50;
        }

        .admin-panel {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 5px solid #ffc107;
        }

        .admin-panel h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .admin-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .today-row {
            background: #d4edda !important;
            border-left: 5px solid #28a745;
        }

        .today-row input {
            background: #d4edda !important;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: all 0.4s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .sync-success {
            background: #28a745;
        }

        .sync-error {
            background: #dc3545;
        }

        @media (max-width: 768px) {
            .store-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .cash-table {
                font-size: 12px;
            }
            
            .cash-table th, .cash-table td {
                padding: 8px 5px;
            }
            
            .text-input-cell {
                font-size: 11px;
                min-height: 25px;
                max-height: 60px;
            }
            
            .text-input-cell:focus {
                min-height: 40px;
                max-height: 80px;
            }
            
            .user-info {
                flex-direction: column;
                text-align: center;
            }

            .table-headers {
                grid-template-columns: 0.7fr 0.8fr 0.7fr 1.2fr 0.7fr 1.2fr 0.7fr 0.8fr 0.8fr !important;
            }

            .cash-table td:nth-child(1) { width: 7%; }
            .cash-table td:nth-child(2) { width: 8%; }
            .cash-table td:nth-child(3) { width: 7%; }
            .cash-table td:nth-child(4) { width: 12%; }
            .cash-table td:nth-child(5) { width: 7%; }
            .cash-table td:nth-child(6) { width: 12%; }
            .cash-table td:nth-child(7) { width: 7%; }
            .cash-table td:nth-child(8) { width: 8%; }
            .cash-table td:nth-child(9) { width: 8%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ –ö–∞—Å—Å–æ–≤–∞—è –∫–Ω–∏–≥–∞</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–ª–∏—á–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ —Å–∞–ª–æ–Ω–æ–≤</p>
        </div>

        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
        <div class="login-section" id="loginSection">
            <div class="login-form">
                <h2>üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
                <div class="form-group">
                    <label>–†–æ–ª—å:</label>
                    <select id="roleSelect">
                        <option value="employee">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –º–∞–≥–∞–∑–∏–Ω–∞</option>
                        <option value="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ú–∞–≥–∞–∑–∏–Ω:</label>
                    <select id="storeSelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>
                        <option value="store1">–¶–î–ú</option>
                        <option value="store2">–ú–µ–≥–≥–∞-–º–µ–±–µ–ª—å</option>
                        <option value="store3">–°–∞–≤–∏–Ω–æ–≤–æ</option>
                        <option value="store4">MZ Life</option>
                        <option value="store5">–¢–¶ –ú–µ–±–µ–ª—å</option>
                        <option value="store6">–î–∏—Å–∫–æ–Ω—Ç-—Ü–µ–Ω—Ç—Ä</option>
                        <option value="store7">–ê—Å—Ç—Ä—É–º</option>
                        <option value="store8">–†–∞–¥—É–≥–∞</option>
                        <option value="store9">–í–î–ù–•</option>
                        <option value="store10">–ú–µ–±–µ–ª—å-–°–∏—Ç–∏ 2</option>
                        <option value="store11">–†—É–º–µ—Ä</option>
                        <option value="store12">–ò–º–ø–µ—Ä–∏—è</option>
                        <option value="store13">–¢—Ä–∏ –ö–∏—Ç–∞</option>
                        <option value="store14">–§—ç–º–µ–ª–∏ –†—É–º</option>
                        <option value="store15">–†—É–º—è–Ω—Ü–µ–≤–æ</option>
                        <option value="store16">–¢–≤–∏–Ω –°—Ç–æ—Ä</option>
                        <option value="store17">–ö—Ä–æ–∫—É—Å</option>
                        <option value="store18">–ú–µ–≥–∞ –ú–æ–ª–ª</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                    <input type="text" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="main-content" id="mainContent">
            <div class="user-info">
                <div>
                    <h3>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span id="userDisplay"></span></h3>
                    <p>üè™ –ú–∞–≥–∞–∑–∏–Ω: <span id="storeDisplay"></span></p>
                    <p>üìÖ –î–∞—Ç–∞: <span id="currentDate"></span></p>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="logout()">–í—ã–π—Ç–∏</button>
                    <button class="btn btn-success" id="exportBtn" onclick="exportToExcel()" style="display: none;">üìä –≠–∫—Å–ø–æ—Ä—Ç</button>
                    <button class="btn" id="syncBtn" onclick="syncData()">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
            <div class="admin-panel" id="adminPanel" style="display: none;">
                <h3>‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
                <div class="admin-controls">
                    <button class="btn" onclick="addNewStore()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω</button>
                    <button class="btn" onclick="viewAllStores()">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤</button>
                    <button class="btn" onclick="generateReport()">üìà –û–±—â–∏–π –æ—Ç—á–µ—Ç</button>
                    <button class="btn btn-danger" onclick="clearAllData()" style="display: none;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
                </div>
            </div>

            <!-- –í—ã–±–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞ (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –∞–¥–º–∏–Ω–∞) -->
            <div class="store-selector" id="storeSelector" style="display: none;">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:</label>
                <select id="managerStoreSelect" onchange="loadStoreData()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>
                    <option value="store1">–¶–î–ú</option>
                    <option value="store2">–ú–µ–≥–≥–∞-–º–µ–±–µ–ª—å</option>
                    <option value="store3">–°–∞–≤–∏–Ω–æ–≤–æ</option>
                    <option value="store4">MZ Life</option>
                    <option value="store5">–¢–¶ –ú–µ–±–µ–ª—å</option>
                    <option value="store6">–î–∏—Å–∫–æ–Ω—Ç-—Ü–µ–Ω—Ç—Ä</option>
                    <option value="store7">–ê—Å—Ç—Ä—É–º</option>
                    <option value="store8">–†–∞–¥—É–≥–∞</option>
                    <option value="store9">–í–î–ù–•</option>
                    <option value="store10">–ú–µ–±–µ–ª—å-–°–∏—Ç–∏ 2</option>
                    <option value="store11">–†—É–º–µ—Ä</option>
                    <option value="store12">–ò–º–ø–µ—Ä–∏—è</option>
                    <option value="store13">–¢—Ä–∏ –ö–∏—Ç–∞</option>
                    <option value="store14">–§—ç–º–µ–ª–∏ –†—É–º</option>
                    <option value="store15">–†—É–º—è–Ω—Ü–µ–≤–æ</option>
                    <option value="store16">–¢–≤–∏–Ω –°—Ç–æ—Ä</option>
                    <option value="store17">–ö—Ä–æ–∫—É—Å</option>
                    <option value="store18">–ú–µ–≥–∞ –ú–æ–ª–ª</option>
                </select>
            </div>

            <div id="cashBookContent" style="max-height: 500px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 10px; position: relative;">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            </div>

            <div class="summary" id="summary">
                <!-- –°–≤–æ–¥–∫–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
    <div id="syncStatus" class="sync-status"></div>

    <script>
        let currentUser = null;
        let currentStore = null;
        let currentRole = null;
        let allStoresData = {};
        let isSyncing = false;
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        const savedData = localStorage.getItem('cashSystemData');
        if (savedData) {
            try {
                allStoresData = JSON.parse(savedData);
                console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage:', allStoresData);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage:', error);
            }
        }

        // URL Google Apps Script
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzgwpw4CajMRK2h8BlKbvV281Bbh2Z-mpt1Ejkdtvw6Tldz7jUQEKXMlTE3NQjCYFlk/exec';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å–µ—Ö —Å–∞–ª–æ–Ω–æ–≤
        function initializeStoresData() {
            const stores = [
                'store1', 'store2', 'store3', 'store4', 'store5', 'store6', 'store7', 'store8',
                'store9', 'store10', 'store11', 'store12', 'store13', 'store14', 'store15', 'store16', 'store17', 'store18'
            ];
            
            stores.forEach(store => {
                if (!allStoresData[store]) {
                    allStoresData[store] = {
                        initialBalance: 0,
                        dailyData: {}
                    };
                }
            });
        }

        function login() {
            const role = document.getElementById('roleSelect').value;
            const store = document.getElementById('storeSelect').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            if (role === 'employee' && !store) {
                alert('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –≤—ã–±—Ä–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω');
                return;
            }

            // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª–µ–π
            const validPasswords = {
                'employee': '123456',
                'manager': 'kirov1997',
                'admin': 'aarbujhm'
            };
            
            // –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∞–ª–æ–Ω–∞ (–¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤) - 6 —Å–ª—É—á–∞–π–Ω—ã—Ö —Ü–∏—Ñ—Ä
            const storePasswords = {
                'store1': '847392',
                'store2': '156847',
                'store3': '293847',
                'store4': '456123',
                'store5': '789456',
                'store6': '321654',
                'store7': '987123',
                'store8': '654789',
                'store9': '147258',
                'store10': '369147',
                'store11': '852963',
                'store12': '741369',
                'store13': '258147',
                'store14': '963852',
                'store15': '147963',
                'store16': '258741',
                'store17': '369258',
                'store18': '741963'
            };

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
            let isValidPassword = false;
            
            if (role === 'employee') {
                // –î–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–∞–ª–æ–Ω–∞
                isValidPassword = password === storePasswords[store];
            } else {
                // –î–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –∞–¥–º–∏–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–∏–µ –ø–∞—Ä–æ–ª–∏
                isValidPassword = password === validPasswords[role];
            }
            
            if (!isValidPassword) {
                if (role === 'employee') {
                    alert(`–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è —Å–∞–ª–æ–Ω–∞ "${getStoreName(store)}"`);
                } else {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                }
                return;
            }

            currentUser = username;
            currentRole = role;
            currentStore = store;

            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage
            localStorage.setItem('currentUser', JSON.stringify({
                username: currentUser,
                role: currentRole,
                store: currentStore
            }));

            showMainContent();
        }

        function showMainContent() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            document.getElementById('userDisplay').textContent = currentUser;
            document.getElementById('storeDisplay').textContent = getStoreName(currentStore);
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });

            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª:', {
                user: currentUser,
                role: currentRole,
                store: currentStore
            });

            // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            if (currentRole === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–ª–µ–∫—Ç–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –∞–¥–º–∏–Ω–∞
            if (currentRole === 'manager' || currentRole === 'admin') {
                document.getElementById('storeSelector').style.display = 'flex';
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –∞–¥–º–∏–Ω–∞
            if (currentRole === 'manager' || currentRole === 'admin') {
                document.getElementById('exportBtn').style.display = 'inline-block';
                console.log('–ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ–∫–∞–∑–∞–Ω–∞ –¥–ª—è —Ä–æ–ª–∏:', currentRole);
            } else {
                // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                document.getElementById('exportBtn').style.display = 'none';
                console.log('–ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å–∫—Ä—ã—Ç–∞ –¥–ª—è —Ä–æ–ª–∏:', currentRole);
            }
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –∫–Ω–æ–ø–∫–∏ "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ"
            const clearDataBtn = document.querySelector('button[onclick="clearAllData()"]');
            if (clearDataBtn) {
                if (currentRole === 'admin') {
                    clearDataBtn.style.display = 'inline-block';
                    console.log('–ö–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ" –ø–æ–∫–∞–∑–∞–Ω–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                } else {
                    clearDataBtn.style.display = 'none';
                    console.log('–ö–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ" —Å–∫—Ä—ã—Ç–∞ –¥–ª—è —Ä–æ–ª–∏:', currentRole);
                }
            } else {
                console.log('–ö–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            }

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω–∞
            if (currentRole === 'employee') {
                loadStoreData(currentStore);
            } else if (currentRole === 'manager' || currentRole === 'admin') {
                // –î–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –∞–¥–º–∏–Ω–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å–∞–ª–æ–Ω–∞
                // –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å–∞–ª–æ–Ω–∞ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ
                console.log('–ú–µ–Ω–µ–¥–∂–µ—Ä/–∞–¥–º–∏–Ω –≤–æ—à–µ–ª. –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å–∞–ª–æ–Ω–∞.');
            }
        }

        function getStoreName(storeId) {
            const storeNames = {
                'store1': '–¶–î–ú',
                'store2': '–ú–µ–≥–≥–∞-–º–µ–±–µ–ª—å',
                'store3': '–°–∞–≤–∏–Ω–æ–≤–æ',
                'store4': 'MZ Life',
                'store5': '–¢–¶ –ú–µ–±–µ–ª—å',
                'store6': '–î–∏—Å–∫–æ–Ω—Ç-—Ü–µ–Ω—Ç—Ä',
                'store7': '–ê—Å—Ç—Ä—É–º',
                'store8': '–†–∞–¥—É–≥–∞',
                'store9': '–í–î–ù–•',
                'store10': '–ú–µ–±–µ–ª—å-–°–∏—Ç–∏ 2',
                'store11': '–†—É–º–µ—Ä',
                'store12': '–ò–º–ø–µ—Ä–∏—è',
                'store13': '–¢—Ä–∏ –ö–∏—Ç–∞',
                'store14': '–§—ç–º–µ–ª–∏ –†—É–º',
                'store15': '–†—É–º—è–Ω—Ü–µ–≤–æ',
                'store16': '–¢–≤–∏–Ω –°—Ç–æ—Ä',
                'store17': '–ö—Ä–æ–∫—É—Å',
                'store18': '–ú–µ–≥–∞ –ú–æ–ª–ª'
            };
            return storeNames[storeId] || storeId;
        }

        async function loadStoreData(storeId = null) {
            const targetStore = storeId || document.getElementById('managerStoreSelect').value;
            if (!targetStore) return;

            currentStore = targetStore;
            document.getElementById('storeDisplay').textContent = getStoreName(currentStore);

            console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∞–ª–æ–Ω–∞: ${currentStore}, —Ä–æ–ª—å: ${currentRole}`);

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets
            await loadDataFromGoogleSheets();
            
            createCashBookTable();
            updateSummary();
        }

        async function loadDataFromGoogleSheets() {
            console.log('–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets...');
            console.log('URL:', GOOGLE_SCRIPT_URL);
            console.log('–¢–µ–∫—É—â–∏–π —Å–∞–ª–æ–Ω:', currentStore);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ URL placeholder
            if (GOOGLE_SCRIPT_URL === '–í–ê–®_–ù–û–í–´–ô_URL_–û–¢_–†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø') {
                console.log('URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage');
                loadFromLocalStorage();
                return;
            }
            
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getData&store=${currentStore}`);
                console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:', response);
                console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', data);
                
                if (data.success) {
                    allStoresData[currentStore] = data.data;
                    console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Google Sheets:', data.data);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', data.error);
                    loadFromLocalStorage();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Google Sheets:', error);
                console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', error.message);
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ fallback
            if (!allStoresData[currentStore]) {
                allStoresData[currentStore] = {
                    initialBalance: 0,
                    dailyData: {}
                };
            }
            console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage:', allStoresData[currentStore]);
        }

        async function saveDataToGoogleSheets() {
            if (isSyncing) return;
            
            isSyncing = true;
            const syncBtn = document.getElementById('syncBtn');
            syncBtn.disabled = true;
            syncBtn.textContent = 'üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ URL placeholder
            if (GOOGLE_SCRIPT_URL === '–í–ê–®_–ù–û–í–´–ô_URL_–û–¢_–†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø') {
                console.log('URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage');
                localStorage.setItem('cashSystemData', JSON.stringify(allStoresData));
                showSyncStatus('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ', 'success');
                isSyncing = false;
                syncBtn.disabled = false;
                syncBtn.textContent = 'üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è';
                return;
            }

            try {
                const requestBody = {
                    action: 'saveData',
                    store: currentStore,
                    data: allStoresData[currentStore]
                };
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    showSyncStatus('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Google Sheets!', 'success');
                    // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
                    localStorage.setItem('cashSystemData', JSON.stringify(allStoresData));
                } else {
                    showSyncStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + result.error, 'error');
                    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage –∫–∞–∫ fallback
                    localStorage.setItem('cashSystemData', JSON.stringify(allStoresData));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                showSyncStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Google Sheets', 'error');
                // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage –∫–∞–∫ fallback
                localStorage.setItem('cashSystemData', JSON.stringify(allStoresData));
            } finally {
                isSyncing = false;
                syncBtn.disabled = false;
                syncBtn.textContent = 'üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è';
            }
        }

        function showSyncStatus(message, type) {
            const status = document.getElementById('syncStatus');
            status.textContent = message;
            status.className = `sync-status sync-${type}`;
            status.style.opacity = '1';
            
            setTimeout(() => {
                status.style.opacity = '0';
            }, 3000);
        }

        function syncData() {
            saveDataToGoogleSheets();
        }

        function createCashBookTable() {
            const content = document.getElementById('cashBookContent');
            const today = new Date().toISOString().split('T')[0];
            const storeData = allStoresData[currentStore];
            
            // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–µ—Ä–∏–æ–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
            let daysToShow = 30; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (currentRole === 'manager' || currentRole === 'admin') {
                daysToShow = 180; // –ø–æ–ª–≥–æ–¥–∞ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –∞–¥–º–∏–Ω–∞
            } else if (currentRole === 'employee') {
                daysToShow = 60; // 2 –º–µ—Å—è—Ü–∞ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            }
            
            // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –Ω—É–∂–Ω—ã–π –ø–µ—Ä–∏–æ–¥
            const dateRange = [];
            for (let i = daysToShow - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                dateRange.push(dateStr);
            }
            
            // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—ã - –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å 27.08.2025
            const startDate = new Date('2025-08-27');
            const filteredDateRange = dateRange.filter(date => {
                const dateObj = new Date(date);
                return dateObj >= startDate;
            });
            
            console.log('–û—Ç–ª–∞–¥–∫–∞ –¥–∞—Ç:', {
                totalDates: dateRange.length,
                filteredDates: filteredDateRange.length,
                startDate: startDate.toISOString(),
                firstDate: dateRange[0],
                lastDate: dateRange[dateRange.length - 1]
            });

            let html = `
                <h2 style="color: #2c3e50; margin-bottom: 20px;">–ö–∞—Å—Å–æ–≤–∞—è –∫–Ω–∏–≥–∞ "${getStoreName(currentStore)}" (${new Date().toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' })})</h2>
                
                <!-- –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã -->
                <div class="table-headers" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 15px 10px; border-radius: 10px 10px 0 0; display: grid; grid-template-columns: 0.8fr 1fr 0.8fr 1.5fr 0.8fr 1.5fr 0.8fr 1fr 1fr; gap: 5px; font-weight: 600; text-align: center; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div>–î–∞—Ç–∞</div>
                    <div>–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –Ω–∞—á–∞–ª–æ –¥–Ω—è</div>
                    <div>–ü—Ä–∏—Ö–æ–¥</div>
                    <div>–ò—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∏—Ö–æ–¥–∞<br><small>(–Ω–∞–≤–µ–¥–∏—Ç–µ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞)</small></div>
                    <div>–†–∞—Å—Ö–æ–¥</div>
                    <div>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞<br><small>(–Ω–∞–≤–µ–¥–∏—Ç–µ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞)</small></div>
                    <div>–°–Ω—è—Ç–∏–µ</div>
                    <div>–§–∞–º–∏–ª–∏—è —Å–Ω–∏–º–∞—é—â–µ–≥–æ</div>
                    <div>–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –∫–æ–Ω–µ—Ü –¥–Ω—è</div>
                </div>
                
                <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-top: none; border-radius: 0 0 10px 10px;">
                    <table class="cash-table" style="width: 100%; border-collapse: collapse; margin: 0;">
                        <tbody>
            `;

            filteredDateRange.forEach((date, index) => {
                const isToday = date === today;
                const dayData = storeData.dailyData[date] || {};
                const canEdit = (currentRole === 'employee' && isToday) || 
                               (currentRole === 'manager') || 
                               (currentRole === 'admin');

                // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                console.log(`–î–∞—Ç–∞: ${date}, –†–æ–ª—å: ${currentRole}, –ú–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: ${canEdit}`);

                html += createTableRow(date, dayData, index, isToday, canEdit);
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            content.innerHTML = html;
            addEventListeners();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ –¥–ª—è –≤—Å–µ—Ö –¥–Ω–µ–π
            calculateInitialBalances(filteredDateRange);
        }

        function calculateInitialBalances(dateRange) {
            let previousEndBalance = allStoresData[currentStore].initialBalance || 0;
            
            dateRange.forEach((date, index) => {
                const dayData = allStoresData[currentStore].dailyData[date] || {};
                
                // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –æ—Å—Ç–∞—Ç–∫–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è
                if (!dayData.startBalance && index > 0) {
                    const previousDate = dateRange[index - 1];
                    const previousDayData = allStoresData[currentStore].dailyData[previousDate] || {};
                    const previousEnd = parseFloat(previousDayData.endBalance) || previousEndBalance;
                    
                    // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    if (!allStoresData[currentStore].dailyData[date]) {
                        allStoresData[currentStore].dailyData[date] = {};
                    }
                    allStoresData[currentStore].dailyData[date].startBalance = previousEnd.toFixed(2);
                    
                    // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    const rowElement = document.querySelector(`input[value="${date}"]`);
                    if (rowElement) {
                        const startBalanceCell = rowElement.closest('tr').querySelector('td:nth-child(2) input');
                        if (startBalanceCell) {
                            startBalanceCell.value = previousEnd.toFixed(2);
                        }
                    }
                    
                    previousEndBalance = previousEnd;
                } else if (dayData.startBalance) {
                    previousEndBalance = parseFloat(dayData.endBalance) || parseFloat(dayData.startBalance);
                }
            });
        }

        function createTableRow(date, dayData, rowIndex, isToday, canEdit) {
            const startBalance = dayData.startBalance || '';
            const income = dayData.income || '';
            const incomeSource = dayData.incomeSource || '';
            const expense = dayData.expense || '';
            const expenseDesc = dayData.expenseDesc || '';
            const withdrawal = dayData.withdrawal || '';
            const withdrawer = dayData.withdrawer || '';
            const endBalance = dayData.endBalance || '';

            const rowClass = isToday ? 'today-row' : '';
            const disabledAttr = canEdit ? '' : 'disabled';
            
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏
            console.log(`–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è ${date}: canEdit=${canEdit}, disabledAttr="${disabledAttr}"`);

            return `
                <tr class="${rowClass}">
                    <td>
                        <input type="date" class="input-cell" value="${date}" 
                               ${disabledAttr} onchange="updateCell('${date}', 'date', this.value)">
                    </td>
                    <td class="balance-cell">
                        <input type="number" class="input-cell" value="${startBalance}" step="0.01"
                               ${disabledAttr} onchange="updateCell('${date}', 'startBalance', this.value)"
                               onblur="calculateEndBalance('${date}')">
                    </td>
                    <td>
                        <input type="number" class="input-cell" value="${income}" step="0.01"
                               ${disabledAttr} onchange="updateCell('${date}', 'income', this.value)"
                               onblur="calculateEndBalance('${date}')">
                    </td>
                    <td class="cell-tooltip" data-tooltip="${incomeSource.replace(/"/g, '&quot;')}">
                        <textarea class="input-cell text-input-cell" 
                                  ${disabledAttr} 
                                  onchange="updateCell('${date}', 'incomeSource', this.value)"
                                  oninput="this.parentElement.setAttribute('data-tooltip', this.value.replace(/\"/g, '&quot;'))"
                                  placeholder="–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞...">${incomeSource}</textarea>
                    </td>
                    <td>
                        <input type="number" class="input-cell" value="${expense}" step="0.01"
                               ${disabledAttr} onchange="updateCell('${date}', 'expense', this.value)"
                               onblur="calculateEndBalance('${date}')">
                    </td>
                    <td class="cell-tooltip" data-tooltip="${expenseDesc.replace(/"/g, '&quot;')}">
                        <textarea class="input-cell text-input-cell" 
                                  ${disabledAttr} 
                                  onchange="updateCell('${date}', 'expenseDesc', this.value)"
                                  oninput="this.parentElement.setAttribute('data-tooltip', this.value.replace(/\"/g, '&quot;'))"
                                  placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞...">${expenseDesc}</textarea>
                    </td>
                    <td>
                        <input type="number" class="input-cell" value="${withdrawal}" step="0.01"
                               ${disabledAttr} onchange="updateCell('${date}', 'withdrawal', this.value)"
                               onblur="calculateEndBalance('${date}')">
                    </td>
                    <td>
                        <input type="text" class="input-cell" value="${withdrawer}"
                               ${disabledAttr} onchange="updateCell('${date}', 'withdrawer', this.value)">
                    </td>
                    <td class="balance-cell">
                        <input type="number" class="input-cell" value="${endBalance}" step="0.01" readonly
                               style="background: #f8f9fa; font-weight: 600;">
                    </td>
                </tr>
            `;
        }

        function updateCell(date, field, value) {
            if (!allStoresData[currentStore].dailyData[date]) {
                allStoresData[currentStore].dailyData[date] = {};
            }
            
            allStoresData[currentStore].dailyData[date][field] = value;
            
            // –û–±–Ω–æ–≤–∏—Ç—å —Å–≤–æ–¥–∫—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
            updateSummary();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Google Sheets
            setTimeout(() => {
                saveDataToGoogleSheets();
            }, 1000); // –ó–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        }

        function calculateEndBalance(date) {
            const dayData = allStoresData[currentStore].dailyData[date] || {};
            const startBalance = parseFloat(dayData.startBalance) || 0;
            const income = parseFloat(dayData.income) || 0;
            const expense = parseFloat(dayData.expense) || 0;
            const withdrawal = parseFloat(dayData.withdrawal) || 0;
            
            const endBalance = startBalance + income - expense - withdrawal;
            
            updateCell(date, 'endBalance', endBalance.toFixed(2));
            
            // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const rowElement = document.querySelector(`input[value="${date}"]`).closest('tr');
            if (rowElement) {
                const endBalanceCell = rowElement.querySelector('td:last-child input');
                if (endBalanceCell) {
                    endBalanceCell.value = endBalance.toFixed(2);
                    endBalanceCell.style.color = endBalance >= 0 ? '#28a745' : '#dc3545';
                }
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
            updateNextDayStartBalance(date, endBalance);
            
            // –û–±–Ω–æ–≤–∏—Ç—å —Å–≤–æ–¥–∫—É –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ –æ—Å—Ç–∞—Ç–∫–∞
            updateSummary();
        }

        function updateNextDayStartBalance(currentDate, endBalance) {
            // –í—ã—á–∏—Å–ª–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é –¥–∞—Ç—É
            const nextDate = new Date(currentDate);
            nextDate.setDate(nextDate.getDate() + 1);
            const nextDateStr = nextDate.toISOString().split('T')[0];
            
            // –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –Ω–∞—á–∞–ª–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
            if (!allStoresData[currentStore].dailyData[nextDateStr]) {
                allStoresData[currentStore].dailyData[nextDateStr] = {};
            }
            
            allStoresData[currentStore].dailyData[nextDateStr].startBalance = endBalance.toFixed(2);
            
            // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ, –µ—Å–ª–∏ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –≤–∏–¥–∏–º
            const nextDayRow = document.querySelector(`input[value="${nextDateStr}"]`);
            if (nextDayRow) {
                const nextDayStartBalanceCell = nextDayRow.closest('tr').querySelector('td:nth-child(2) input');
                if (nextDayStartBalanceCell) {
                    nextDayStartBalanceCell.value = endBalance.toFixed(2);
                }
            }
        }

        function updateSummary() {
            const summary = document.getElementById('summary');
            const today = new Date().toISOString().split('T')[0];
            const storeData = allStoresData[currentStore];
            
            let totalIncome = 0;
            let totalExpense = 0;
            let totalWithdrawal = 0;
            let currentBalance = storeData.initialBalance;

            // –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å —Å—É–º–º—ã –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            console.log('–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü:', currentMonth, '–¢–µ–∫—É—â–∏–π –≥–æ–¥:', currentYear);
            console.log('–î–∞–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω–∞:', storeData.dailyData);
            
            Object.keys(storeData.dailyData).forEach(date => {
                const dateObj = new Date(date);
                console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—É:', date, '–ú–µ—Å—è—Ü:', dateObj.getMonth(), '–ì–æ–¥:', dateObj.getFullYear());
                if (dateObj.getMonth() === currentMonth && dateObj.getFullYear() === currentYear) {
                    const dayData = storeData.dailyData[date];
                    const income = parseFloat(dayData.income) || 0;
                    const expense = parseFloat(dayData.expense) || 0;
                    const withdrawal = parseFloat(dayData.withdrawal) || 0;
                    
                    totalIncome += income;
                    totalExpense += expense;
                    totalWithdrawal += withdrawal;
                    
                    console.log('–î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞', date, ':', {income, expense, withdrawal});
                }
            });
            
            console.log('–ò—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã:', {
                initialBalance: storeData.initialBalance,
                totalIncome,
                totalExpense,
                totalWithdrawal,
                calculatedBalance: storeData.initialBalance + totalIncome - totalExpense - totalWithdrawal
            });

            // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: –Ω–∞—á–∞–ª—å–Ω—ã–π + –ø—Ä–∏—Ö–æ–¥ - —Ä–∞—Å—Ö–æ–¥ - —Å–Ω—è—Ç–∏–µ
            currentBalance = storeData.initialBalance + totalIncome - totalExpense - totalWithdrawal;
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü, –≤–∑—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Å—Ç–∞—Ç–æ–∫
            const sortedDates = Object.keys(storeData.dailyData).sort();
            if (sortedDates.length > 0) {
                const lastDate = sortedDates[sortedDates.length - 1];
                const lastEndBalance = parseFloat(storeData.dailyData[lastDate].endBalance);
                if (!isNaN(lastEndBalance)) {
                    currentBalance = lastEndBalance;
                }
            }

            const monthNames = [
                '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
            ];

            summary.innerHTML = `
                <h3>üìä –°–≤–æ–¥–∫–∞ –∑–∞ ${monthNames[currentMonth]} ${currentYear}</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <h4>–ü—Ä–∏—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü</h4>
                        <div class="value positive">+${totalIncome.toFixed(2)} ‚ÇΩ</div>
                    </div>
                    <div class="summary-item">
                        <h4>–†–∞—Å—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü</h4>
                        <div class="value negative">-${totalExpense.toFixed(2)} ‚ÇΩ</div>
                    </div>
                    <div class="summary-item">
                        <h4>–°–Ω—è—Ç–∏–µ –∑–∞ –º–µ—Å—è—Ü</h4>
                        <div class="value negative">-${totalWithdrawal.toFixed(2)} ‚ÇΩ</div>
                    </div>
                </div>
            `;
        }

        function exportToExcel() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ - —Ç–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
            if (currentRole !== 'manager' && currentRole !== 'admin') {
                alert('‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö. –¢–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–≥—É—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.');
                console.log('–ü–æ–ø—ã—Ç–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Å —Ä–æ–ª—å—é:', currentRole);
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            csvContent += "–°–∞–ª–æ–Ω,–î–∞—Ç–∞,–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –Ω–∞—á–∞–ª–æ –¥–Ω—è,–ü—Ä–∏—Ö–æ–¥,–ò—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∏—Ö–æ–¥–∞,–†–∞—Å—Ö–æ–¥,–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞,–°–Ω—è—Ç–∏–µ,–§–∞–º–∏–ª–∏—è —Å–Ω–∏–º–∞—é—â–µ–≥–æ,–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –∫–æ–Ω–µ—Ü –¥–Ω—è\n";
            
            // –î–∞–Ω–Ω—ã–µ
            const storeData = allStoresData[currentStore];
            const sortedDates = Object.keys(storeData.dailyData).sort();
            
            sortedDates.forEach(date => {
                const dayData = storeData.dailyData[date];
                if (dayData.startBalance || dayData.income || dayData.expense || dayData.withdrawal) {
                    csvContent += `${getStoreName(currentStore)},${date},${dayData.startBalance || ''},${dayData.income || ''},"${dayData.incomeSource || ''}",${dayData.expense || ''},"${dayData.expenseDesc || ''}",${dayData.withdrawal || ''},"${dayData.withdrawer || ''}",${dayData.endBalance || ''}\n`;
                }
            });
            
            // –°–æ–∑–¥–∞—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `–∫–∞—Å—Å–æ–≤–∞—è_–∫–Ω–∏–≥–∞_${getStoreName(currentStore)}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function logout() {
            currentUser = null;
            currentStore = null;
            currentRole = null;
            
            localStorage.removeItem('currentUser');
            
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            
            // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è —Ñ–æ—Ä–º—ã
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function addEventListeners() {
            // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
            const rows = document.querySelectorAll('#cashBookContent tbody tr');
            rows.forEach((row, rowIndex) => {
                const inputs = row.querySelectorAll('input[type="number"]:not([readonly])');
                inputs.forEach(input => {
                    input.addEventListener('blur', () => {
                        const date = row.querySelector('input[type="date"]').value;
                        calculateEndBalance(date);
                    });
                    
                    // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è
                    input.addEventListener('input', () => {
                        const date = row.querySelector('input[type="date"]').value;
                        setTimeout(() => calculateEndBalance(date), 100);
                    });
                });

                // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è textarea
                const textareas = row.querySelectorAll('textarea');
                textareas.forEach(textarea => {
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
                    textarea.addEventListener('input', function() {
                        this.style.height = 'auto';
                        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                    });

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ tooltip –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
                    textarea.addEventListener('input', function() {
                        const tooltip = this.parentElement;
                        tooltip.setAttribute('data-tooltip', this.value.replace(/"/g, '&quot;'));
                    });
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        function addNewStore() {
            const storeName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞:');
            if (storeName) {
                const storeId = 'store' + (Object.keys(allStoresData).length + 1);
                allStoresData[storeId] = {
                    initialBalance: 0,
                    dailyData: {}
                };
                alert(`–ú–∞–≥–∞–∑–∏–Ω "${storeName}" –¥–æ–±–∞–≤–ª–µ–Ω —Å ID: ${storeId}`);
            }
        }

        function viewAllStores() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ - –º–µ–Ω–µ–¥–∂–µ—Ä –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
            if (currentRole !== 'manager' && currentRole !== 'admin') {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö —Å–∞–ª–æ–Ω–æ–≤');
                return;
            }
            
            let report = 'üìä –û—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º —Å–∞–ª–æ–Ω–∞–º:\n\n';
            
            Object.keys(allStoresData).forEach(storeId => {
                const storeData = allStoresData[storeId];
                const totalIncome = Object.values(storeData.dailyData).reduce((sum, day) => sum + (parseFloat(day.income) || 0), 0);
                const totalExpense = Object.values(storeData.dailyData).reduce((sum, day) => sum + (parseFloat(day.expense) || 0), 0);
                const totalWithdrawal = Object.values(storeData.dailyData).reduce((sum, day) => sum + (parseFloat(day.withdrawal) || 0), 0);
                
                report += `${getStoreName(storeId)}:\n`;
                report += `  –ü—Ä–∏—Ö–æ–¥: ${totalIncome.toFixed(2)} ‚ÇΩ\n`;
                report += `  –†–∞—Å—Ö–æ–¥: ${totalExpense.toFixed(2)} ‚ÇΩ\n`;
                report += `  –°–Ω—è—Ç–∏–µ: ${totalWithdrawal.toFixed(2)} ‚ÇΩ\n`;
                report += `  –û—Å—Ç–∞—Ç–æ–∫: ${(totalIncome - totalExpense - totalWithdrawal).toFixed(2)} ‚ÇΩ\n\n`;
            });
            
            alert(report);
        }

        function generateReport() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ - –º–µ–Ω–µ–¥–∂–µ—Ä –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
            if (currentRole !== 'manager' && currentRole !== 'admin') {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–æ–≤');
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "–°–∞–ª–æ–Ω,–û–±—â–∏–π –ø—Ä–∏—Ö–æ–¥,–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥,–û–±—â–µ–µ —Å–Ω—è—Ç–∏–µ,–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫\n";
            
            Object.keys(allStoresData).forEach(storeId => {
                const storeData = allStoresData[storeId];
                const totalIncome = Object.values(storeData.dailyData).reduce((sum, day) => sum + (parseFloat(day.income) || 0), 0);
                const totalExpense = Object.values(storeData.dailyData).reduce((sum, day) => sum + (parseFloat(day.expense) || 0), 0);
                const totalWithdrawal = Object.values(storeData.dailyData).reduce((sum, day) => sum + (parseFloat(day.withdrawal) || 0), 0);
                const currentBalance = totalIncome - totalExpense - totalWithdrawal;
                
                csvContent += `${getStoreName(storeId)},${totalIncome.toFixed(2)},${totalExpense.toFixed(2)},${totalWithdrawal.toFixed(2)},${currentBalance.toFixed(2)}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `–æ–±—â–∏–π_–æ—Ç—á–µ—Ç_—Å–∞–ª–æ–Ω–æ–≤_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearAllData() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ - —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
            if (currentRole !== 'admin') {
                alert('‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è. –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ.');
                console.log('–ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Å —Ä–æ–ª—å—é:', currentRole);
                return;
            }
            
            // –ü–µ—Ä–≤–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            const firstConfirm = confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö —Å–∞–ª–æ–Ω–æ–≤!\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ:\n‚Ä¢ –£–¥–∞–ª–∏—Ç –≤—Å–µ –∫–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏\n‚Ä¢ –ù–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å\n‚Ä¢ –ü–æ—Ç—Ä–µ–±—É–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏\n\n–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?');
            
            if (!firstConfirm) {
                return;
            }
            
            // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
            const createBackup = confirm('üíæ –•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º?\n\n–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö.');
            
            if (createBackup) {
                try {
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
                    const backupData = JSON.stringify(allStoresData, null, 2);
                    const blob = new Blob([backupData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `—Ä–µ–∑–µ—Ä–≤–Ω–∞—è_–∫–æ–ø–∏—è_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert('‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å–∫–∞—á–∞–Ω–∞.');
                } catch (error) {
                    alert('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é: ' + error.message);
                }
            }
            
            // –í—Ç–æ—Ä–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –≤–≤–æ–¥–æ–º –∫–æ–¥–∞
            const securityCode = prompt('üîí –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: "–£–î–ê–õ–ò–¢–¨"');
            
            if (securityCode !== '–£–î–ê–õ–ò–¢–¨') {
                alert('‚ùå –ö–æ–¥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π. –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.');
                return;
            }
            
            // –§–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            const finalConfirm = confirm('üö® –ü–û–°–õ–ï–î–ù–ï–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï!\n\n–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?\n\n–ù–∞–∂–º–∏—Ç–µ "–û–ö" –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–ª–∏ "–û—Ç–º–µ–Ω–∞" –¥–ª—è –æ—Ç–º–µ–Ω—ã.');
            
            if (!finalConfirm) {
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.');
                return;
            }
            
            // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
            try {
                allStoresData = {};
                initializeStoresData();
                
                // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                if (currentStore) {
                    createCashBookTable();
                    updateSummary();
                }
                
                alert('üóëÔ∏è –í—Å–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã.\n\n‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç–æ–π.');
                
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            initializeStoresData();
            
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                currentUser = userData.username;
                currentRole = userData.role;
                currentStore = userData.store;
                showMainContent();
            }
        };
    </script>
</body>
</html>
